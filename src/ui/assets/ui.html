<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Money Manager - å°è´¦ç²¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- å›¾æ ‡å’Œå›¾è¡¨åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <style>
    /* å…¨å±€æ ·å¼å˜é‡ */
    :root{
      --primary:#1abc9c; --primary-light:#a2e1d4;
      --text:#1f2937; --sub:#6b7280; --line:#e5e7eb;
      --income:#10b981; --expense:#ef4444;
      --radius-lg:22px; --radius:14px;
      --shadow:0 10px 26px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0;}
    body{
      background:linear-gradient(135deg,#f4f9fd 0%,#e8f5fb 100%);
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      display:flex; justify-content:center; align-items:stretch;
      overflow:hidden;
    }
    .app-shell{
      width:100%; max-width:480px; height:100vh;
      background:#fff; border-radius:26px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .header{
      padding:14px 18px; display:flex; justify-content:space-between; align-items:center;
      background:rgba(255,255,255,.96); backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line); z-index:10;
    }
    .header-main{display:flex; flex-direction:column;}
    .header-title{font-size:20px; font-weight:800;}
    .header-subtitle{font-size:13px; color:var(--sub)}
    .icon-button{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer}
    .content{flex:1; padding:16px 18px 90px; overflow-y:auto;}

    /* é¡µé¢æ ·å¼ */
    .page{display:none; flex-direction:column; gap:12px; min-height:100%}
    .page.active{display:flex}

    .balance-card{
      background:linear-gradient(135deg,#1abc9c 0%,#16a085 60%,#149174 100%);
      color:#fff; border-radius:22px; padding:18px; box-shadow:var(--shadow);
    }
    .balance-amount{font-size:30px; font-weight:800; margin:6px 0 10px}
    .balance-meta{display:flex; gap:18px; font-size:14px}

    .budget-card{background:#fff;border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow);cursor:pointer}
    .budget-header{display:flex;justify-content:space-between;align-items:center}
    .progress-bar{height:8px;border-radius:999px;background:#edf2f7;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,#10b981,#f59e0b);transition:width .25s}
    .progress-text{font-size:13px;color:var(--sub);margin-top:4px}

    .section-title{font-size:15px;font-weight:700;margin-top:4px}

    .transaction-list{display:flex;flex-direction:column;gap:10px}
    .transaction-item{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:var(--radius);padding:10px 12px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
    .transaction-category{width:34px;height:34px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;color:var(--primary)}

    .btn{padding:12px 16px;border:none;border-radius:999px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}

    /* è®°è´¦é¡µ */
    .toggle-switch{background:#edf2f7;border-radius:999px;padding:4px;display:inline-flex;gap:6px}
    .switch-option{padding:5px 12px;border-radius:999px;font-size:13px;color:var(--sub);cursor:pointer}
    .switch-option.active{background:#fff;color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .amount-input{width:100%;font-size:32px;font-weight:800;border:none;border-bottom:1px solid var(--line);padding:6px 0 12px;outline:none}
    .form-group{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .form-label{font-size:13px;color:var(--sub)}
    .text-input,.search-input,.date-input{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:15px;outline:none;background:#fff}
    .text-input:focus,.search-input:focus,.date-input:focus{border-color:var(--primary)}
    .category-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .category-item{min-width:84px;padding:8px 10px;border-radius:12px;background:#f7fafb;cursor:pointer}
    .category-item.active{background:#e0fbf6;border:1px solid #17a98d}
    .category-actions{display:flex;gap:10px;margin-top:10px}

    /* ç»Ÿè®¡é¡µ */
    .summary-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .summary-card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.05);cursor:pointer}
    .summary-label{font-size:13px;color:var(--sub)}
    .summary-value{font-size:18px;font-weight:800;margin-top:2px}
    #main-chart{width:100%;height:260px;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:10px}

    /* ç”¨æˆ·èµ„æ–™åŒºåŸŸ */
    .user-header{
      background:linear-gradient(135deg,#1abc9c 0%,#16a085 100%);
      color:#fff;border-radius:18px;padding:20px;margin-bottom:12px;box-shadow:var(--shadow);
    }
    .user-avatar{font-size:48px;margin-bottom:8px}
    .user-name{font-size:20px;font-weight:800;margin-bottom:2px}
    .user-status{font-size:13px;opacity:0.9}
    .user-info-item{background:#fff;border-radius:12px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .user-info-label{font-size:13px;color:var(--sub);margin-bottom:4px}
    .user-info-value{font-size:14px;font-weight:600;color:var(--text)}
    .user-info-edit{color:var(--primary);cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap}

    /* è®¾ç½®åŒºåŸŸ - æ”¹ä¸ºåˆ—è¡¨é£æ ¼ */
    .settings-group{background:#fff;border-radius:12px;padding:0;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);overflow:hidden}
    .settings-group-title{font-size:12px;font-weight:700;color:var(--sub);margin-bottom:0;padding:12px 14px 8px 14px;text-transform:uppercase;letter-spacing:0.5px}
    .settings-item{display:flex;flex-direction:row;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--line);gap:12px}
    .settings-item:last-child{border-bottom:none}
    .settings-label{font-size:14px;color:var(--text);font-weight:500;flex:1;display:flex;justify-content:space-between;align-items:center}
    .settings-value{font-size:12px;color:var(--sub)}
    .toggle-checkbox{width:48px;height:28px;background:#ccc;border-radius:14px;cursor:pointer;position:relative;transition:background 0.3s;flex-shrink:0}
    .toggle-checkbox.active{background:var(--primary)}
    .toggle-checkbox::after{content:'';position:absolute;width:24px;height:24px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left 0.3s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .toggle-checkbox.active::after{left:22px}

    /* ç™»å½•è¡¨å• */
    .login-card{background:#fff;border-radius:18px;padding:24px;box-shadow:var(--shadow);text-align:center}
    .login-title{font-size:22px;font-weight:800;margin-bottom:12px}
    .login-subtitle{font-size:13px;color:var(--sub);margin-bottom:20px}
    .login-input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px;font-size:14px;outline:none}
    .login-input:focus{border-color:var(--primary)}
    .login-buttons{display:flex;gap:10px;margin-top:16px}
    .login-buttons button{flex:1;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer}

    /* åº•éƒ¨å¯¼èˆª */
    .bottom-nav{position:absolute;left:0;right:0;bottom:0;height:74px;background:#fff;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;padding:8px 14px;z-index:20}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;color:var(--sub);cursor:pointer;font-size:13px}
    .nav-item i{font-size:20px}
    .nav-item.active{color:var(--primary)}
    .nav-item.active::after{content:"";width:6px;height:6px;border-radius:999px;background:var(--primary)}
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- é¡¶éƒ¨ -->
    <div class="header">
      <div class="header-main">
        <div class="header-title" id="header-title">é¦–é¡µ</div>
        <div class="header-subtitle" id="header-subtitle">æ¬¢è¿ä½¿ç”¨å°è´¦ç²¾</div>
      </div>
      <button class="icon-button" id="header-add-btn"><i class="fas fa-pen"></i></button>
    </div>

    <!-- å¯æ»šåŠ¨å†…å®¹ -->
    <div class="content">
      <!-- é¦–é¡µ -->
      <div class="page active" data-page="home">
        <div class="balance-card">
          <div style="font-size:13px;opacity:.95;">æœ¬æœˆç»“ä½™</div>
          <div class="balance-amount" id="home-balance">Â¥0.00</div>
          <div class="balance-meta">
            <div><div>æ”¶å…¥</div><div id="home-income" style="font-weight:700">Â¥0.00</div></div>
            <div><div>æ”¯å‡º</div><div id="home-expense" style="font-weight:700">Â¥0.00</div></div>
          </div>
        </div>

        <!-- é¦–é¡µé¢„ç®— -->
        <div class="budget-card" id="home-budget-card">
          <div class="budget-header">
            <div style="font-weight:700">é¢„ç®—ç®¡ç†</div>
            <div style="color:var(--sub);font-size:13px" id="home-budget-brief">0 / 0 (0%)</div>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="home-budget-progress"></div></div>
          <div class="progress-text" id="home-budget-percent">å·²ç”¨ 0%</div>
        </div>

        <div class="section-title">æœ€è¿‘è®°å½•</div>
        <div class="transaction-list" id="home-recent-list"></div>
      </div>

      <!-- è®°è´¦ -->
      <div class="page" data-page="record">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="section-title">è®°ä¸€ç¬”</div>
          <div class="toggle-switch" id="record-type">
            <div class="switch-option active" data-type="expense">æ”¯å‡º</div>
            <div class="switch-option" data-type="income">æ”¶å…¥</div>
          </div>
        </div>

        <input type="number" class="amount-input" id="record-amount" placeholder="0.00" />
        <!-- æ—¥æœŸé€‰æ‹© -->
        <div class="form-group">
          <div class="form-label">æ—¥æœŸ</div>
          <input type="date" class="date-input" id="record-date" />
        </div>

        <div class="form-group">
          <div class="form-label">åˆ†ç±»</div>
          <div class="category-grid" id="record-category-grid"></div>
          <div class="category-actions">
            <button class="btn" id="record-manage-btn">åˆ†ç±»ç®¡ç†</button>
            <button class="btn" id="record-clear-cat-btn" style="background:#9ca3af">æ¸…é™¤é€‰æ‹©</button>
          </div>
        </div>

        <div class="form-group">
          <div class="form-label">å¤‡æ³¨</div>
          <input type="text" class="text-input" id="record-note" placeholder="å¦‚ï¼šåˆé¤ã€åœ°é“ã€å¥¶èŒ¶â€¦" />
        </div>
        <div class="form-group">
          <div class="form-label">å•†å®¶/åœºæ‰€</div>
          <input type="text" class="text-input" id="record-store" placeholder="å¦‚ï¼šæ˜Ÿå·´å…‹ã€ç›’é©¬ã€ç¾å›¢â€¦" />
        </div>
        <div style="margin-top:14px"><button class="btn" id="record-save-btn" style="width:100%">ä¿å­˜è®°å½•</button></div>
      </div>

      <!-- ç»Ÿè®¡ -->
      <div class="page" data-page="stats">
        <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
        <div class="form-group">
          <div class="form-label">ç»Ÿè®¡æ—¶é—´èŒƒå›´</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" data-period="day" style="flex:1;min-width:60px;font-size:13px;padding:8px">ä»Šå¤©</button>
            <button class="btn" data-period="week" style="flex:1;min-width:60px;font-size:13px;padding:8px">æœ¬å‘¨</button>
            <button class="btn" data-period="month" style="flex:1;min-width:60px;font-size:13px;padding:8px;background:var(--primary)">æœ¬æœˆ</button>
            <button class="btn" data-period="year" style="flex:1;min-width:60px;font-size:13px;padding:8px">æœ¬å¹´</button>
            <button class="btn" data-period="custom" style="flex:1;min-width:60px;font-size:13px;padding:8px">è‡ªå®šä¹‰</button>
          </div>
          <div id="custom-date-range" style="display:none;margin-top:10px;gap:8px">
            <input type="date" class="date-input" id="stats-start-date" style="flex:1" />
            <span style="margin:0 8px">è‡³</span>
            <input type="date" class="date-input" id="stats-end-date" style="flex:1" />
            <button class="btn" id="stats-apply-custom" style="margin-top:8px;width:100%">åº”ç”¨</button>
          </div>
        </div>

        <!-- æ”¶æ”¯ç»Ÿè®¡å¡ç‰‡ -->
        <div class="summary-row">
          <div class="summary-card" id="stats-expense-card">
            <div class="summary-label">æ€»æ”¯å‡º</div>
            <div class="summary-value" id="stats-expense">Â¥0.00</div>
          </div>
          <div class="summary-card" id="stats-income-card">
            <div class="summary-label">æ€»æ”¶å…¥</div>
            <div class="summary-value" id="stats-income">Â¥0.00</div>
          </div>
        </div>

        <div class="section-title">æ”¶æ”¯è¶‹åŠ¿</div>
        <div id="trend-chart" style="width:100%;height:200px;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:10px;margin-bottom:12px"></div>

        <div class="section-title">åˆ†ç±»åˆ†å¸ƒ</div>
        <div id="main-chart"></div>

        <!-- æ¶ˆè´¹åˆ†ææŒ‰é’® -->
        <button class="btn" id="open-insights">æ¶ˆè´¹åˆ†æ</button>
      </div>

      <!-- æ¶ˆè´¹åˆ†æé¡µé¢ -->
      <div class="page" data-page="insights">
        <div class="section-title">æ¶ˆè´¹åˆ†æ</div>
        <div id="insights-text" style="background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);font-size:15px;color:var(--sub)">
          æ­£åœ¨ç”Ÿæˆâ€¦
        </div>
        <div style="margin-top:14px"><button class="btn" id="insights-back">è¿”å›ç»Ÿè®¡</button></div>
      </div>

      <!-- æœç´¢ -->
      <div class="page" data-page="search">
        <div class="form-group">
          <div class="form-label">æœç´¢æ¡ä»¶</div>
          <input type="text" class="search-input" id="search-keyword" placeholder="å…³é”®å­—ï¼ˆåˆ†ç±»ã€å•†å®¶ã€å¤‡æ³¨ï¼‰" />
        </div>
        <div class="form-group">
          <div class="form-label">åˆ†ç±»</div>
          <select class="text-input" id="search-category" style="padding:10px 12px">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">é‡‘é¢èŒƒå›´</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="number" class="text-input" id="search-amount-min" placeholder="æœ€å°é‡‘é¢" style="flex:1" />
            <span>è‡³</span>
            <input type="number" class="text-input" id="search-amount-max" placeholder="æœ€å¤§é‡‘é¢" style="flex:1" />
          </div>
        </div>
        <div class="form-group">
          <div class="form-label">æ—¥æœŸèŒƒå›´</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="date" class="date-input" id="search-start-date" style="flex:1" />
            <span>è‡³</span>
            <input type="date" class="date-input" id="search-end-date" style="flex:1" />
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <button class="btn" id="search-btn" style="flex:1">æœç´¢</button>
          <button class="btn" id="search-reset-btn" style="flex:1;background:#9ca3af">é‡ç½®</button>
        </div>
        <div class="form-group">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="form-label">æœç´¢å†å²</div>
            <button class="btn" id="search-clear-history" style="padding:6px 12px;font-size:12px;background:#ef4444">æ¸…ç©ºå†å²</button>
          </div>
          <div id="search-history" style="display:flex;flex-wrap:wrap;gap:6px"></div>
        </div>
        <div style="font-size:13px;color:var(--sub)" id="search-summary">å…± 0 æ¡è®°å½•</div>
        <div class="transaction-list" id="search-results"></div>
      </div>

      <!-- é¢„ç®—ç®¡ç†é¡µé¢ -->
      <div class="page" data-page="budget">
        <div class="section-title">é¢„ç®—ç®¡ç†</div>
        <div class="form-group">
          <div class="form-label">æœ¬æœˆé¢„ç®—æ€»é¢ï¼ˆå…ƒï¼‰</div>
          <input type="number" class="text-input" id="budget-input" placeholder="å¦‚ï¼š10000" />
        </div>
        <div style="margin-top:10px"><button class="btn" id="budget-save-btn" style="width:100%">ä¿å­˜é¢„ç®—</button></div>

        <div class="section-title">æœ¬æœˆä½¿ç”¨æƒ…å†µ</div>
        <div class="budget-card" id="budget-status-card">
          <div class="budget-header">
            <div id="budget-brief">0 / 0 (0%)</div>
            <div style="color:var(--sub);font-size:13px">å½“æœˆæ”¯å‡º / é¢„ç®—æ€»é¢</div>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="budget-progress"></div></div>
          <div class="progress-text" id="budget-percent">å·²ç”¨ 0%</div>
          <div id="budget-warning" style="margin-top:12px;padding:10px;border-radius:8px;display:none;font-size:13px;line-height:1.5"></div>
        </div>
      </div>

      <!-- åˆ†ç±»ç®¡ç† -->
      <div class="page" data-page="category">
        <div class="section-title">åˆ†ç±»ç®¡ç†</div>
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <button class="btn" id="category-add-expense-btn" style="flex:1;background:var(--expense)">æ·»åŠ æ”¯å‡ºåˆ†ç±»</button>
          <button class="btn" id="category-add-income-btn" style="flex:1;background:var(--income)">æ·»åŠ æ”¶å…¥åˆ†ç±»</button>
        </div>
        <div id="category-container" class="transaction-list"></div>
        <div style="margin-top:14px">
          <button class="btn" id="category-back" style="width:100%;background:#9ca3af">è¿”å›è®°è´¦</button>
        </div>
      </div>

      <!-- æˆ‘çš„ -->
      <div class="page" data-page="profile">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-section">
          <div class="login-card">
            <div class="login-title">ğŸ‘¤ å°è´¦ç²¾</div>
            <div class="login-subtitle">è¯·è¾“å…¥ç”¨æˆ·åå¼€å§‹ä½¿ç”¨</div>
            <input type="text" class="login-input" id="login-username" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆæ˜µç§°ï¼‰">
            <div class="login-buttons">
              <button id="login-btn" style="background:var(--primary);color:#fff">ç™»å½•</button>
              <button id="guest-btn" style="background:#e5e7eb;color:var(--text)">æ¸¸å®¢ä½¿ç”¨</button>
            </div>
          </div>
        </div>

        <!-- å·²ç™»å½•ç•Œé¢ -->
        <div id="profile-section" style="display:none;flex-direction:column;gap:16px">
          <!-- ç”¨æˆ·å¤´éƒ¨ -->
          <div class="user-header">
            <div class="user-avatar" id="profile-avatar">ğŸ‘¤</div>
            <div class="user-name" id="profile-nickname">ç”¨æˆ·æ˜µç§°</div>
            <div class="user-status" id="profile-status">å·²ç™»å½•</div>
          </div>

          <!-- è´¦æˆ·ä¿¡æ¯ - ç»Ÿä¸€åˆ—è¡¨æ ·å¼ -->
          <div>
            <div class="section-title" style="margin-bottom:8px">è´¦æˆ·ä¿¡æ¯</div>
            <div class="settings-group">
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-user" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">ç”¨æˆ·å</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span class="user-info-value" id="profile-username" style="color:var(--text);font-weight:500">-</span>
                  <div class="user-info-edit" id="edit-username-btn" style="padding:4px 8px;border-radius:6px;background:var(--primary-light);color:var(--primary);font-size:12px">ç¼–è¾‘</div>
                </div>
              </div>
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-envelope" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">é‚®ç®±</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span class="user-info-value" id="profile-email" style="color:var(--text);font-weight:500">-</span>
                  <div class="user-info-edit" id="edit-email-btn" style="padding:4px 8px;border-radius:6px;background:var(--primary-light);color:var(--primary);font-size:12px">ç¼–è¾‘</div>
                </div>
              </div>
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-smile" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">å¤´åƒ</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span class="user-info-value" id="profile-avatar-display" style="font-size:20px">ğŸ‘¤</span>
                  <div class="user-info-edit" id="edit-avatar-btn" style="padding:4px 8px;border-radius:6px;background:var(--primary-light);color:var(--primary);font-size:12px">æ›´æ”¹</div>
                </div>
              </div>
            </div>
          </div>

          <!-- é€šçŸ¥æé†’ - ç»Ÿä¸€åˆ—è¡¨æ ·å¼ -->
          <div>
            <div class="section-title" style="margin-bottom:8px">é€šçŸ¥æé†’</div>
            <div class="settings-group">
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-bell" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">é¢„ç®—æé†’</span>
                </div>
                <div class="toggle-checkbox active" id="toggle-budget" data-key="budget_notifications"></div>
              </div>
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-calendar-day" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">æ¯æ—¥æé†’</span>
                </div>
                <div class="toggle-checkbox" id="toggle-daily" data-key="daily_reminders"></div>
              </div>
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-exclamation-triangle" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">è¶…æ”¯è­¦å‘Š</span>
                </div>
                <div class="toggle-checkbox active" id="toggle-warning" data-key="expense_warnings"></div>
              </div>
            </div>
          </div>

          <!-- æ•°æ®ç®¡ç† - ç»Ÿä¸€åˆ—è¡¨æ ·å¼ -->
          <div>
            <div class="section-title" style="margin-bottom:8px">æ•°æ®ç®¡ç†</div>
            <div class="settings-group">
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-cloud-upload-alt" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">è‡ªåŠ¨å¤‡ä»½</span>
                </div>
                <div class="toggle-checkbox active" id="toggle-backup" data-key="auto_backup"></div>
              </div>
              <div class="settings-item">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-eye-slash" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label">éšè—é‡‘é¢</span>
                </div>
                <div class="toggle-checkbox" id="toggle-hide" data-key="hide_amounts"></div>
              </div>
            </div>
          </div>

          <!-- åŠŸèƒ½é€‰é¡¹ - ç»Ÿä¸€åˆ—è¡¨æ ·å¼ -->
          <div>
            <div class="section-title" style="margin-bottom:8px">åŠŸèƒ½</div>
            <div class="settings-group">
              <button class="settings-item" id="records-manage-btn" style="border:none;background:none;cursor:pointer;width:100%;text-align:left;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
                <div style="display:flex;align-items:center;gap:10px;flex:1">
                  <i class="fas fa-list-alt" style="color:var(--primary);font-size:16px;width:20px"></i>
                  <span class="settings-label" style="margin:0">è´¦å•ç®¡ç†</span>
                </div>
                <i class="fas fa-chevron-right" style="color:var(--sub);font-size:12px;flex-shrink:0"></i>
              </button>
            </div>
          </div>

          <!-- é€€å‡ºç™»å½• -->
          <div style="margin-top:8px">
            <button id="logout-btn" style="width:100%;padding:14px;border:none;border-radius:12px;background:#ef4444;color:#fff;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 2px 8px rgba(239,68,68,0.3);transition:all 0.2s">
              <i class="fas fa-sign-out-alt" style="margin-right:8px"></i>é€€å‡ºç™»å½•
            </button>
          </div>

          <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
          <div style="text-align:center;color:var(--sub);font-size:12px;padding:16px 0;margin-top:8px">
            å°è´¦ç²¾ v1.0 | Â© 2025
          </div>
        </div>
      </div>

      <!-- è´¦å•ç®¡ç† -->
      <div class="page" data-page="records">
        <div class="section-title">è´¦å•ç®¡ç†</div>
        <div id="records-container" class="transaction-list"></div>
        <div style="margin-top:14px"><button class="btn" id="records-back" style="width:100%;background:#9ca3af">è¿”å›</button></div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <div class="nav-item active" data-target="home"><i class="fas fa-home"></i><span>é¦–é¡µ</span></div>
      <div class="nav-item" data-target="record"><i class="fas fa-pen"></i><span>è®°è´¦</span></div>
      <div class="nav-item" data-target="stats"><i class="fas fa-chart-pie"></i><span>ç»Ÿè®¡</span></div>
      <div class="nav-item" data-target="search"><i class="fas fa-search"></i><span>æœç´¢</span></div>
      <div class="nav-item" data-target="profile"><i class="fas fa-user"></i><span>æˆ‘çš„</span></div>
    </div>
  </div>

  <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
  <script>
    (function(){
      const pages = Array.from(document.querySelectorAll(".page"));
      const navItems = Array.from(document.querySelectorAll(".nav-item"));
      const headerTitle = document.getElementById("header-title");
      const headerSubtitle = document.getElementById("header-subtitle");
      const headerAddBtn = document.getElementById("header-add-btn");

      function showPage(name){
        pages.forEach(p => p.classList.toggle("active", p.dataset.page===name));
        navItems.forEach(n => n.classList.toggle("active", n.dataset.target===name));
        const titles = {home:"é¦–é¡µ",record:"è®°ä¸€ç¬”",stats:"ç»Ÿè®¡",search:"æœç´¢",budget:"é¢„ç®—ç®¡ç†",category:"åˆ†ç±»ç®¡ç†",profile:"æˆ‘çš„",insights:"æ¶ˆè´¹åˆ†æ",records:"è´¦å•ç®¡ç†"};
        headerTitle.textContent = titles[name] || "è®°è´¦æœ¬";
        headerSubtitle.textContent =
          name==="home" ? "æ¬¢è¿ä½¿ç”¨å°è´¦ç²¾" :
          name==="record" ? "å¿«é€Ÿè®°å½•ä¸€ç¬”æ”¶æ”¯" :
          name==="stats" ? "æŸ¥çœ‹æ”¶æ”¯ç»“æ„ä¸è¶‹åŠ¿" :
          name==="search" ? "æŒ‰å•†å®¶æˆ–åˆ†ç±»æŸ¥æ‰¾è®°å½•" :
          name==="budget" ? "è®¾ç½®é¢„ç®—å¹¶æŸ¥çœ‹å½“æœˆä½¿ç”¨" :
          name==="category" ? "ç®¡ç†ä½ çš„åˆ†ç±»æ ‡ç­¾" :
          name==="insights" ? "åŸºäºä½ çš„è®°å½•ç”Ÿæˆåˆ†æ" :
          name==="records" ? "æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è´¦å•" :
          "ä¸ªäººä¿¡æ¯ä¸åº”ç”¨è¯´æ˜";
        headerAddBtn.style.display = name==="home" ? "flex" : "none";
      }

      navItems.forEach(n => n.addEventListener("click", ()=>{
        const t = n.dataset.target;
        showPage(t);
        if (t==="home") loadHome();
        if (t==="stats") loadStats();
        if (t==="category") loadCategories();
        if (t==="records") loadRecords();
        if (t==="profile") loadUserProfile();
        if (t==="budget") { loadHomeBudgetSection(); loadBudgetStatus(); }
        if (t==="search") { loadSearchHistory(); }
      }));
      headerAddBtn.addEventListener("click", ()=> showPage("record"));

      let backend = null; new QWebChannel(qt.webChannelTransport, ch=>{
        backend = ch.objects.backend;
        // åˆå§‹
        setToday(); loadHome(); loadCategories(); bindRecord(); bindSearch(); bindBudget(); bindStats(); loadUserProfile(); loadSettings();
      });

      // é¦–é¡µå’Œé¢„ç®—åŠŸèƒ½
      function loadHome(){
        if(!backend) return;
        backend.get_home_overview(function(resp){
          try{
            const d = JSON.parse(resp);
            document.getElementById("home-balance").textContent = fmt(d.balance);
            document.getElementById("home-income").textContent  = fmt(d.income);
            document.getElementById("home-expense").textContent = fmt(d.expense);

            const used = Number(d.budget_used||0), total = Number(d.budget_total||0), p = Number(d.budget_percent||0);
            document.getElementById("home-budget-brief").textContent = `${fmtRaw(used)} / ${fmtRaw(total)} (${p}%)`;
            document.getElementById("home-budget-percent").textContent = `å·²ç”¨ ${p}%`;
            document.getElementById("home-budget-progress").style.width = `${p}%`;

            const list = document.getElementById("home-recent-list"); list.innerHTML="";
            (d.recent||[]).forEach(it=>{
              const color = it.r_type==="income" ? "var(--income)" : "var(--expense)";
              list.appendChild(el(`
                <div class="transaction-item">
                  <div style="display:flex;align-items:center;gap:10px">
                    <div class="transaction-category"><i class="fas fa-receipt"></i></div>
                    <div>
                      <div style="font-weight:700">${it.category||"æœªåˆ†ç±»"}</div>
                      <div style="font-size:13px;color:var(--sub)">${(it.store||"")+(it.date?(" Â· "+it.date):"")}</div>
                    </div>
                  </div>
                  <div style="font-weight:700;color:${color}">${fmt(it.amount)}</div>
                </div>`));
            });
          }catch(e){console.error(e)}
        });
      }
      document.getElementById("home-budget-card").addEventListener("click",()=>{ showPage("budget"); loadHomeBudgetSection(); loadBudgetStatus(); });

      function loadHomeBudgetSection(){
        // åœ¨é¢„ç®—é¡µåŒæ­¥æ˜¾ç¤ºï¼ˆå½“æœˆä½¿ç”¨/æ€»é¢/ç™¾åˆ†æ¯”ï¼‰
        if(!backend) return;
        backend.get_home_overview(function(resp){
          try{
            const d = JSON.parse(resp);
            const used = Number(d.budget_used||0), total = Number(d.budget_total||0), p = Number(d.budget_percent||0);
            document.getElementById("budget-brief").textContent = `${fmtRaw(used)} / ${fmtRaw(total)} (${p}%)`;
            document.getElementById("budget-percent").textContent = `å·²ç”¨ ${p}%`;
            document.getElementById("budget-progress").style.width = `${p}%`;
          }catch(e){}
        });
      }

      // è®°è´¦åŠŸèƒ½
      function setToday(){
        const inp = document.getElementById("record-date");
        const today = new Date(); const m = String(today.getMonth()+1).padStart(2,"0");
        const d = String(today.getDate()).padStart(2,"0");
        inp.value = `${today.getFullYear()}-${m}-${d}`;
      }

      function bindRecord(){
        const typeWrap = document.getElementById("record-type");
        typeWrap.querySelectorAll(".switch-option").forEach(opt=>{
          opt.addEventListener("click", ()=>{
            typeWrap.querySelectorAll(".switch-option").forEach(o=>o.classList.remove("active"));
            opt.classList.add("active");
            // åˆ‡æ¢æ˜¾ç¤ºä¸åŒç±»å‹åˆ†ç±»ï¼ˆæ”¯å‡º/æ”¶å…¥ï¼‰
            loadCategoriesToRecord();
          });
        });

        document.getElementById("record-manage-btn").addEventListener("click",()=>{
          showPage("category"); loadCategories();
        });
        document.getElementById("record-clear-cat-btn").addEventListener("click",()=>{
          document.querySelectorAll("#record-category-grid .category-item").forEach(i=> i.classList.remove("active"));
        });

        document.getElementById("record-save-btn").addEventListener("click", ()=>{
          if(!backend) return;
          const amount = parseFloat(document.getElementById("record-amount").value||"0");
          if(!amount){ toast("è¯·è¾“å…¥é‡‘é¢"); return; }
          const type = document.querySelector("#record-type .switch-option.active")?.dataset.type || "expense";
          const catEl = document.querySelector("#record-category-grid .category-item.active .category-name");
          const category = catEl ? catEl.textContent.trim() : "å…¶ä»–";
          const note  = document.getElementById("record-note").value || "";
          const store = document.getElementById("record-store").value || "";
          const record_date = document.getElementById("record-date").value;

          backend.add_record(JSON.stringify({amount:amount, r_type:type, category, note, store, record_date}), function(r){
            try{
              const res = JSON.parse(r); if(res.ok){
                toast("è®°å½•å·²ä¿å­˜");
                document.getElementById("record-amount").value="";
                document.getElementById("record-note").value="";
                document.getElementById("record-store").value="";
                loadHome(); loadStats();
                // å¦‚æœæ˜¯æ”¯å‡ºè®°å½•ï¼Œæ£€æŸ¥é¢„ç®—çŠ¶æ€
                if(type === "expense" && backend){
                  setTimeout(()=>{ loadBudgetStatus(); }, 500);
                }
              }else{ toast("ä¿å­˜å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯")); }
            }catch(e){ toast("ä¿å­˜å¤±è´¥"); }
          });
        });

        loadCategoriesToRecord();
      }

      function loadCategoriesToRecord(){
        if(!backend) return;
        backend.get_categories(function(resp){
          try{
            const list = JSON.parse(resp)||[];
            const type = document.querySelector("#record-type .switch-option.active")?.dataset.type || "expense";
            const filtered = list.filter(x => (x.c_type||"expense") === type);
            const grid = document.getElementById("record-category-grid");
            grid.innerHTML="";
            filtered.forEach(item=>{
              if(!item.name) return;
              const node = el(`
                <div class="category-item">
                  <div class="category-name">${item.name}</div>
                  <div style="font-size:12px;color:var(--sub)">${ type==="income" ? "æ”¶å…¥åˆ†ç±»":"æ”¯å‡ºåˆ†ç±»" }</div>
                </div>`);
              node.addEventListener("click", ()=>{
                if(node.classList.contains("active")){
                  node.classList.remove("active");
                  return;
                }
                grid.querySelectorAll(".category-item").forEach(i=>i.classList.remove("active"));
                node.classList.add("active");
              });
              grid.appendChild(node);
            });
          }catch(e){}
        });
      }

      // åˆ†ç±»ç®¡ç†
      function loadCategories(){
        if(!backend) return;
        backend.get_categories(function(resp){
          try{
            const list = JSON.parse(resp)||[];
            const ctn = document.getElementById("category-container"); ctn.innerHTML = "";
            list.forEach(item=>{
              if(!item.name) return;
              ctn.appendChild(el(`
                <div class="transaction-item">
                  <div style="display:flex;align-items:center;gap:10px">
                    <div class="transaction-category"><i class="fas fa-folder"></i></div>
                    <div>
                      <div style="font-weight:700">${item.name}</div>
                      <div style="font-size:13px;color:var(--sub)">${(item.c_type==="income"?"æ”¶å…¥":"æ”¯å‡º")}åˆ†ç±»</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px">
                    <button class="icon-button edit" data-id="${item.category_id}" data-name="${item.name}" data-type="${item.c_type}" title="ç¼–è¾‘"><i class="fas fa-pen"></i></button>
                    <button class="icon-button del" data-id="${item.category_id}" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                  </div>
                </div>`));
            });
            ctn.querySelectorAll(".edit").forEach(b=> b.addEventListener("click",()=>{
              const id = parseInt(b.dataset.id);
              const oldName = b.dataset.name;
              const oldType = b.dataset.type;
              const newName = prompt("åˆ†ç±»åç§°ï¼š", oldName);
              if(newName === null) return; // ç”¨æˆ·å–æ¶ˆ
              const typeChoice = prompt("åˆ†ç±»ç±»å‹ï¼ˆè¾“å…¥ 1=æ”¶å…¥ï¼Œ2=æ”¯å‡ºï¼Œç›´æ¥å›è½¦ä¿æŒåŸç±»å‹ï¼‰ï¼š", oldType==="income"?"1":"2");
              let newType = oldType;
              if(typeChoice === "1") newType = "income";
              else if(typeChoice === "2") newType = "expense";
              // è°ƒç”¨åç«¯æ¥å£
              backend.edit_category(JSON.stringify({category_id: id, name: newName, c_type: newType}), function(r){
                try{
                  const res = JSON.parse(r);
                  if(res.ok){
                    toast("åˆ†ç±»å·²æ›´æ–°");
                    loadCategories(); loadCategoriesToRecord();
                  }else{
                    toast("æ›´æ–°å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
                  }
                }catch(e){ toast("æ›´æ–°å¤±è´¥"); }
              });
            }));
            ctn.querySelectorAll(".del").forEach(b=> b.addEventListener("click",()=>{
              const id = parseInt(b.dataset.id);
              if(confirm("ç¡®å®šåˆ é™¤è¯¥åˆ†ç±»ï¼Ÿ") && backend) {
                backend.delete_category(id, function(r){
                  try{
                    const res = JSON.parse(r);
                    if(res.ok){
                      toast("åˆ†ç±»å·²åˆ é™¤");
                      loadCategories(); loadCategoriesToRecord();
                    }else{
                      toast("åˆ é™¤å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
                    }
                  }catch(e){ toast("åˆ é™¤å¤±è´¥"); }
                });
              }
            }));
          }catch(e){}
        });
      }
      document.getElementById("category-add-expense-btn").addEventListener("click",()=>{
        if(!backend) return;
        const name = prompt("æ–°æ”¯å‡ºåˆ†ç±»åç§°ï¼š");
        if(!name) return;
        backend.add_category(JSON.stringify({name: name, c_type: "expense"}), function(r){
          try{
            const res = JSON.parse(r);
            if(res.ok){
              toast("æ”¯å‡ºåˆ†ç±»å·²æ·»åŠ ");
              loadCategories(); loadCategoriesToRecord();
            }else{
              toast("æ·»åŠ å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
            }
          }catch(e){ toast("æ·»åŠ å¤±è´¥"); }
        });
      });
      document.getElementById("category-add-income-btn").addEventListener("click",()=>{
        if(!backend) return;
        const name = prompt("æ–°æ”¶å…¥åˆ†ç±»åç§°ï¼š");
        if(!name) return;
        backend.add_category(JSON.stringify({name: name, c_type: "income"}), function(r){
          try{
            const res = JSON.parse(r);
            if(res.ok){
              toast("æ”¶å…¥åˆ†ç±»å·²æ·»åŠ ");
              loadCategories(); loadCategoriesToRecord();
            }else{
              toast("æ·»åŠ å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
            }
          }catch(e){ toast("æ·»åŠ å¤±è´¥"); }
        });
      });
      document.getElementById("category-back").addEventListener("click",()=>{ showPage("record"); });

      // è´¦å•ç®¡ç†
      function loadRecords(){
        if(!backend) return;
        backend.get_all_records(function(resp){
          try{
            const d = JSON.parse(resp)||{};
            const list = d.records||[];
            const ctn = document.getElementById("records-container"); ctn.innerHTML = "";
            if(list.length === 0){
              ctn.innerHTML = '<div style="text-align:center;padding:20px;color:var(--sub)">æš‚æ— è´¦å•è®°å½•</div>';
              return;
            }
            list.forEach(item=>{
              const color = item.r_type==="income" ? "var(--income)" : "var(--expense)";
              ctn.appendChild(el(`
                <div class="transaction-item">
                  <div style="display:flex;align-items:center;gap:10px;flex:1">
                    <div class="transaction-category"><i class="fas fa-receipt"></i></div>
                    <div style="flex:1">
                      <div style="font-weight:700">${item.category||"æœªåˆ†ç±»"}</div>
                      <div style="font-size:13px;color:var(--sub)">${(item.store||"")+(item.date?(" Â· "+item.date):"")}</div>
                      ${item.note ? `<div style="font-size:12px;color:var(--sub);margin-top:2px">${item.note}</div>` : ""}
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                    <div style="font-weight:700;color:${color}">${fmt(item.amount)}</div>
                    <div style="display:flex;gap:8px">
                      <button class="icon-button edit-record" data-id="${item.record_id}" title="ç¼–è¾‘"><i class="fas fa-pen"></i></button>
                      <button class="icon-button del-record" data-id="${item.record_id}" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                    </div>
                  </div>
                </div>`));
            });
            // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
            ctn.querySelectorAll(".edit-record").forEach(b=> b.addEventListener("click",()=>{
              const id = parseInt(b.dataset.id);
              editRecord(id);
            }));
            ctn.querySelectorAll(".del-record").forEach(b=> b.addEventListener("click",()=>{
              const id = parseInt(b.dataset.id);
              if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è´¦å•è®°å½•ï¼Ÿ") && backend) {
                backend.delete_record(id, function(r){
                  try{
                    const res = JSON.parse(r);
                    if(res.ok){
                      toast("è´¦å•å·²åˆ é™¤");
                      loadRecords(); loadHome(); loadStats();
                    }else{
                      toast("åˆ é™¤å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
                    }
                  }catch(e){ toast("åˆ é™¤å¤±è´¥"); }
                });
              }
            }));
          }catch(e){ console.error(e); }
        });
      }

      function editRecord(recordId){
        if(!backend) return;
        // å…ˆè·å–è®°å½•è¯¦æƒ…
        backend.get_all_records(function(resp){
          try{
            const d = JSON.parse(resp)||{};
            const list = d.records||[];
            const record = list.find(r=>r.record_id === recordId);
            if(!record){
              toast("æœªæ‰¾åˆ°è¯¥è®°å½•");
              return;
            }
            // å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†
            const amount = prompt("é‡‘é¢ï¼š", record.amount);
            if(amount === null) return;
            const typeChoice = prompt("ç±»å‹ï¼ˆè¾“å…¥ 1=æ”¶å…¥ï¼Œ2=æ”¯å‡ºï¼Œç›´æ¥å›è½¦ä¿æŒåŸç±»å‹ï¼‰ï¼š", record.r_type==="income"?"1":"2");
            let r_type = record.r_type;
            if(typeChoice === "1") r_type = "income";
            else if(typeChoice === "2") r_type = "expense";
            const category = prompt("åˆ†ç±»ï¼š", record.category) || record.category;
            const note = prompt("å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š", record.note || "") || "";
            const store = prompt("å•†å®¶/åœºæ‰€ï¼ˆå¯é€‰ï¼‰ï¼š", record.store || "") || "";
            const record_date = prompt("æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ï¼š", record.date || "");
            // è°ƒç”¨åç«¯æ¥å£
            backend.edit_record(JSON.stringify({
              record_id: recordId,
              amount: parseFloat(amount),
              r_type: r_type,
              category: category,
              note: note,
              store: store,
              record_date: record_date || record.date
            }), function(r){
              try{
                const res = JSON.parse(r);
                if(res.ok){
                  toast("è´¦å•å·²æ›´æ–°");
                  loadRecords(); loadHome(); loadStats();
                }else{
                  toast("æ›´æ–°å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
                }
              }catch(e){ toast("æ›´æ–°å¤±è´¥"); }
            });
          }catch(e){ toast("è·å–è®°å½•å¤±è´¥"); }
        });
      }

      document.getElementById("records-manage-btn").addEventListener("click",()=>{ showPage("records"); loadRecords(); });
      document.getElementById("records-back").addEventListener("click",()=>{ showPage("profile"); });

      // ç”¨æˆ·å’Œè®¾ç½®
      function loadUserProfile(){
        if(!backend) return;
        backend.get_user_profile(function(resp){
          try{
            const user = JSON.parse(resp);
            if(user.is_logged_in){
              document.getElementById("login-section").style.display = "none";
              document.getElementById("profile-section").style.display = "flex";
              const name = user.nickname || user.username || "";
              document.getElementById("profile-nickname").textContent = name;
              document.getElementById("profile-username").textContent = user.username;
              document.getElementById("profile-email").textContent = user.email || "æœªè®¾ç½®";
              document.getElementById("profile-avatar").textContent = user.avatar_emoji || "ğŸ‘¤";
              document.getElementById("profile-avatar-display").textContent = user.avatar_emoji || "ğŸ‘¤";
              // æ›´æ–°é¡¶éƒ¨æ¬¢è¿æ–‡æ¡ˆ
              if(typeof headerSubtitle !== "undefined") headerSubtitle.textContent = "æ¬¢è¿å›æ¥ï¼Œ" + name;
              if(typeof headerTitle !== "undefined") headerTitle.textContent = name || headerTitle.textContent;
            }else{
              document.getElementById("login-section").style.display = "flex";
              document.getElementById("profile-section").style.display = "none";
              // æœªç™»å½•æ—¶æ¢å¤é»˜è®¤è¡¨å¤´
              if(typeof headerTitle !== "undefined") headerTitle.textContent = "é¦–é¡µ";
              if(typeof headerSubtitle !== "undefined") headerSubtitle.textContent = "æ¬¢è¿ä½¿ç”¨å°è´¦ç²¾";
            }
          }catch(e){ console.error(e); }
        });
      }

      function loadSettings(){
        if(!backend) return;
        backend.get_settings(function(resp){
          try{
            const settings = JSON.parse(resp);
            document.getElementById("toggle-budget").classList.toggle("active", settings.budget_notifications);
            document.getElementById("toggle-daily").classList.toggle("active", settings.daily_reminders);
            document.getElementById("toggle-warning").classList.toggle("active", settings.expense_warnings);
            document.getElementById("toggle-backup").classList.toggle("active", settings.auto_backup);
            document.getElementById("toggle-hide").classList.toggle("active", settings.hide_amounts);
          }catch(e){ console.error(e); }
        });
      }

      // ç™»å½•äº‹ä»¶
      document.getElementById("login-btn").addEventListener("click", ()=>{
        const username = document.getElementById("login-username").value.trim();
        if(!username){
          toast("è¯·è¾“å…¥ç”¨æˆ·å");
          return;
        }
        backend.user_login(JSON.stringify({username: username}), function(r){
          try{
            const res = JSON.parse(r);
            if(res.ok){
              toast("ç™»å½•æˆåŠŸ");
              loadUserProfile();
              loadSettings();
            }else{
              toast("ç™»å½•å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
            }
          }catch(e){ toast("ç™»å½•å¤±è´¥"); }
        });
      });

      // æ¸¸å®¢ä½¿ç”¨
      document.getElementById("guest-btn").addEventListener("click", ()=>{
        backend.user_login(JSON.stringify({username: "æ¸¸å®¢"}), function(r){
          try{
            const res = JSON.parse(r);
            if(res.ok){
              toast("å·²ä½¿ç”¨æ¸¸å®¢æ¨¡å¼");
              loadUserProfile();
              loadSettings();
            }
          }catch(e){ }
        });
      });

      // ç™»å‡ºäº‹ä»¶
      document.getElementById("logout-btn").addEventListener("click", ()=>{
        if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")){
          backend.user_logout(function(r){
            try{
              const res = JSON.parse(r);
              if(res.ok){
                toast("å·²é€€å‡ºç™»å½•");
                document.getElementById("login-username").value = "";
                loadUserProfile();
              }
            }catch(e){ }
          });
        }
      });

      // ç¼–è¾‘ç”¨æˆ·å
      document.getElementById("edit-username-btn").addEventListener("click", ()=>{
        const username = prompt("è¯·è¾“å…¥ç”¨æˆ·åï¼š", document.getElementById("profile-username").textContent);
        if(username !== null && username.trim()){
          // åŒæ—¶ä¼  nicknameï¼Œç¡®ä¿æ˜¾ç¤ºååŒæ­¥æ›´æ–°
          backend.update_user_profile(JSON.stringify({username: username.trim(), nickname: username.trim()}), function(r){
            try{
              const res = JSON.parse(r);
              if(res.ok){
                toast("ç”¨æˆ·åå·²æ›´æ–°");
                // ä½¿ç”¨åç«¯è¿”å›çš„ user å¯¹è±¡ï¼Œç«‹å³æ›´æ–°é¡µé¢ä¸­æ‰€æœ‰ç›¸å…³æ˜¾ç¤º
                if(res.user){
                  const name = res.user.nickname || res.user.username || "";
                  // æ›´æ–°ä¸ªäººèµ„æ–™åŒº
                  const pn = document.getElementById("profile-nickname"); if(pn) pn.textContent = name;
                  const pu = document.getElementById("profile-username"); if(pu) pu.textContent = res.user.username || "-";
                  const pe = document.getElementById("profile-email"); if(pe) pe.textContent = res.user.email || "æœªè®¾ç½®";
                  const pa = document.getElementById("profile-avatar"); if(pa) pa.textContent = res.user.avatar_emoji || "ğŸ‘¤";
                  const pad = document.getElementById("profile-avatar-display"); if(pad) pad.textContent = res.user.avatar_emoji || "ğŸ‘¤";
                  // æ›´æ–°é¡¶éƒ¨è¡¨å¤´ä¸ºæ¬¢è¿æ–‡æ¡ˆ
                  if(typeof headerTitle !== "undefined") headerTitle.textContent = name || headerTitle.textContent;
                  if(typeof headerSubtitle !== "undefined") headerSubtitle.textContent = "æ¬¢è¿å›æ¥ï¼Œ" + (name || "");
                }
                // åŒæ­¥åˆ·æ–°åç«¯åŠ è½½çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆæŒä¹…åŒ–åä»¥é˜²ä¸‡ä¸€ï¼‰
                loadUserProfile();
              }else{
                toast("æ›´æ–°å¤±è´¥ï¼š"+(res.error||"æœªçŸ¥é”™è¯¯"));
              }
            }catch(e){ toast("æ›´æ–°å¤±è´¥"); }
          });
        }
      });

      // ç¼–è¾‘é‚®ç®±
      document.getElementById("edit-email-btn").addEventListener("click", ()=>{
        const email = prompt("è¯·è¾“å…¥é‚®ç®±åœ°å€ï¼š", document.getElementById("profile-email").textContent);
        if(email !== null){
          backend.update_user_profile(JSON.stringify({email: email}), function(r){
            try{
              const res = JSON.parse(r);
              if(res.ok){
                toast("é‚®ç®±å·²æ›´æ–°");
                loadUserProfile();
              }
            }catch(e){ }
          });
        }
      });

      // ç¼–è¾‘å¤´åƒ
      const avatars = ["ğŸ‘¤", "ğŸ˜€", "ğŸ˜", "ğŸ‰", "ğŸ”¥", "â­", "ğŸ¯", "ğŸ’"];
      document.getElementById("edit-avatar-btn").addEventListener("click", ()=>{
        let choice = prompt("é€‰æ‹©å¤´åƒ (0-7)ï¼Œæˆ–è¾“å…¥emoji:\n" + avatars.join(" "), "0");
        if(choice !== null){
          let avatar = avatars[parseInt(choice)] || choice;
          backend.update_user_profile(JSON.stringify({avatar_emoji: avatar}), function(r){
            try{
              const res = JSON.parse(r);
              if(res.ok){
                toast("å¤´åƒå·²æ›´æ–°");
                loadUserProfile();
              }
            }catch(e){ }
          });
        }
      });

      // åˆ‡æ¢é€šçŸ¥è®¾ç½®
      document.querySelectorAll(".toggle-checkbox").forEach(toggle=>{
        toggle.addEventListener("click", function(){
          const key = this.dataset.key;
          const value = !this.classList.contains("active");
          const updates = {};
          updates[key] = value;
          backend.update_settings(JSON.stringify(updates), function(r){
            try{
              const res = JSON.parse(r);
              if(res.ok){
                document.querySelector(`.toggle-checkbox[data-key="${key}"]`).classList.toggle("active", value);
                toast("è®¾ç½®å·²ä¿å­˜");
              }
            }catch(e){ }
          });
        });
      });

      // æœç´¢åŠŸèƒ½
      let searchHistory = JSON.parse(localStorage.getItem("searchHistory") || "[]");

      function bindSearch(){
        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        if(backend){
          backend.get_search_categories(function(resp){
            try{
              const cats = JSON.parse(resp)||[];
              const select = document.getElementById("search-category");
              select.innerHTML = '<option value="">å…¨éƒ¨</option>';
              cats.forEach(cat=>{
                const opt = document.createElement("option");
                opt.value = cat.name;
                opt.textContent = cat.name;
                select.appendChild(opt);
              });
            }catch(e){}
          });
        }

        // åŠ è½½æœç´¢å†å²
        loadSearchHistory();

        // æœç´¢æŒ‰é’®
        document.getElementById("search-btn").addEventListener("click", performSearch);
        
        // å›è½¦æœç´¢
        document.getElementById("search-keyword").addEventListener("keydown", e=>{
          if(e.key==="Enter") performSearch();
        });

        // é‡ç½®æŒ‰é’®
        document.getElementById("search-reset-btn").addEventListener("click", ()=>{
          document.getElementById("search-keyword").value = "";
          document.getElementById("search-category").value = "";
          document.getElementById("search-amount-min").value = "";
          document.getElementById("search-amount-max").value = "";
          document.getElementById("search-start-date").value = "";
          document.getElementById("search-end-date").value = "";
          document.getElementById("search-results").innerHTML = "";
          document.getElementById("search-summary").textContent = "å…± 0 æ¡è®°å½•";
        });

        // æ¸…ç©ºå†å²
        document.getElementById("search-clear-history").addEventListener("click", ()=>{
          if(confirm("ç¡®å®šè¦æ¸…ç©ºæœç´¢å†å²å—ï¼Ÿ")){
            searchHistory = [];
            localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
            loadSearchHistory();
          }
        });
      }

      function performSearch(){
        if(!backend) return;
        const keyword = document.getElementById("search-keyword").value.trim();
        const category = document.getElementById("search-category").value;
        const amountMin = document.getElementById("search-amount-min").value;
        const amountMax = document.getElementById("search-amount-max").value;
        const startDate = document.getElementById("search-start-date").value;
        const endDate = document.getElementById("search-end-date").value;

        const searchParams = {};
        if(keyword) searchParams.keyword = keyword;
        if(category) searchParams.category = category;
        if(amountMin) searchParams.amount_min = amountMin;
        if(amountMax) searchParams.amount_max = amountMax;
        if(startDate) searchParams.start_date = startDate;
        if(endDate) searchParams.end_date = endDate;

        // ä¿å­˜æœç´¢å†å²ï¼ˆå»é‡ï¼‰
        const historyKey = JSON.stringify(searchParams);
        if(historyKey && !searchHistory.includes(historyKey)){
          searchHistory.unshift(historyKey);
          // æœ€å¤šä¿å­˜10æ¡
          if(searchHistory.length > 10) searchHistory.pop();
          localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
          loadSearchHistory();
        }

        backend.search(JSON.stringify(searchParams), function(resp){
          try{
            const d = JSON.parse(resp)||{}; 
            const list = d.records||[]; 
            const results = document.getElementById("search-results");
            const summary = document.getElementById("search-summary");
            results.innerHTML=""; 
            let total=0;
            list.forEach(it=>{
              total += Number(it.amount)||0;
              const color = it.r_type==="income" ? "var(--income)" : "var(--expense)";
              results.appendChild(el(`
                <div class="transaction-item">
                  <div style="display:flex;align-items:center;gap:10px">
                    <div class="transaction-category"><i class="fas fa-search"></i></div>
                    <div>
                      <div style="font-weight:700">${it.category||"æœªåˆ†ç±»"}</div>
                      <div style="font-size:13px;color:var(--sub)">${(it.store||"")+(it.date?(" Â· "+it.date):"")}</div>
                      ${it.note ? `<div style="font-size:12px;color:var(--sub);margin-top:2px">${it.note}</div>` : ""}
                    </div>
                  </div>
                  <div style="font-weight:700;color:${color}">${fmt(it.amount)}</div>
                </div>`));
            });
            summary.textContent = `å…± ${list.length} æ¡è®°å½• Â· åˆè®¡ ${fmtRaw(total)}`;
          }catch(e){ console.error(e); }
        });
      }

      function loadSearchHistory(){
        const historyDiv = document.getElementById("search-history");
        historyDiv.innerHTML = "";
        if(searchHistory.length === 0){
          historyDiv.innerHTML = '<div style="color:var(--sub);font-size:12px">æš‚æ— æœç´¢å†å²</div>';
          return;
        }
        searchHistory.forEach((historyItem, index)=>{
          try{
            const params = JSON.parse(historyItem);
            const label = [
              params.keyword ? `å…³é”®å­—:${params.keyword}` : "",
              params.category ? `åˆ†ç±»:${params.category}` : "",
              params.amount_min || params.amount_max ? `é‡‘é¢:${params.amount_min||0}-${params.amount_max||"âˆ"}` : "",
              params.start_date || params.end_date ? `æ—¥æœŸ:${params.start_date||""}-${params.end_date||""}` : ""
            ].filter(x=>x).join(" ") || "å…¨éƒ¨";
            
            const tag = el(`
              <div style="padding:4px 10px;background:#f3f4f6;border-radius:12px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px">
                <span>${label}</span>
                <i class="fas fa-times" style="font-size:10px;color:var(--sub)"></i>
              </div>
            `);
            tag.addEventListener("click", ()=>{
              // ç‚¹å‡»å†å²è®°å½•ï¼Œå¡«å……æœç´¢æ¡ä»¶å¹¶æ‰§è¡Œæœç´¢
              if(params.keyword) document.getElementById("search-keyword").value = params.keyword;
              if(params.category) document.getElementById("search-category").value = params.category;
              if(params.amount_min) document.getElementById("search-amount-min").value = params.amount_min;
              if(params.amount_max) document.getElementById("search-amount-max").value = params.amount_max;
              if(params.start_date) document.getElementById("search-start-date").value = params.start_date;
              if(params.end_date) document.getElementById("search-end-date").value = params.end_date;
              performSearch();
            });
            // åˆ é™¤å†å²è®°å½•
            tag.querySelector("i").addEventListener("click", (e)=>{
              e.stopPropagation();
              searchHistory.splice(index, 1);
              localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
              loadSearchHistory();
            });
            historyDiv.appendChild(tag);
          }catch(e){}
        });
      }

      // é¢„ç®—åŠŸèƒ½
      function bindBudget(){
        document.getElementById("budget-save-btn").addEventListener("click", ()=>{
          const v = document.getElementById("budget-input").value || "0";
          backend.save_budget(v, function(){
            toast("é¢„ç®—å·²ä¿å­˜");
            // é‡æ–°ä»åç«¯è·å–ç”¨äºåˆ·æ–°ç™¾åˆ†æ¯”ï¼ˆé¿å…å½’é›¶ï¼‰
            loadHome(); loadHomeBudgetSection(); loadBudgetStatus();
          });
        });
      }

      function loadBudgetStatus(){
        if(!backend) return;
        backend.get_budget_status(function(resp){
          try{
            const d = JSON.parse(resp)||{};
            const level = d.level || "normal";
            const message = d.message || "";
            const percent = Number(d.percent||0);
            const used = Number(d.used||0);
            const total = Number(d.total||0);
            
            const card = document.getElementById("budget-status-card");
            const progress = document.getElementById("budget-progress");
            const warning = document.getElementById("budget-warning");
            
            // æ ¹æ®é¢„ç®—ä½¿ç”¨æƒ…å†µè®¾ç½®é¢œè‰²
            let cardColor = "#fff";
            let progressColor = "#10b981";
            let warningColor = "#10b981";
            let warningText = "";
            let showWarning = false;
            
            if(level === "over" || percent >= 100){
              cardColor = "#fee2e2"; // æµ…çº¢è‰²èƒŒæ™¯
              progressColor = "#ef4444"; // çº¢è‰²è¿›åº¦æ¡
              warningColor = "#dc2626"; // æ·±çº¢è‰²æ–‡å­—
              warningText = "âš ï¸ ä¸»äººï¼Œæœˆåº•è¦åƒåœŸå•¦ï¼é¢„ç®—å·²è¶…å‡ºï¼Œè¯·æ§åˆ¶æ”¯å‡ºï¼";
              showWarning = true;
              // å¼¹çª—çº¢è‰²é¢„è­¦
              setTimeout(()=>{
                showBudgetAlert("é¢„ç®—è¶…æ”¯é¢„è­¦", message || "ä¸»äººä¸»äººï¼ï¼ï¼å†ä¹±èŠ±é’±æœˆåº•è¦åƒåœŸå•¦ï¼ï¼ï¼", "error");
              }, 300);
            } else if(level === "warning" || percent >= 80){
              cardColor = "#fef3c7"; // æµ…é»„è‰²èƒŒæ™¯
              progressColor = "#f59e0b"; // æ©™è‰²è¿›åº¦æ¡
              warningColor = "#d97706"; // æ·±æ©™è‰²æ–‡å­—
              warningText = "âš ï¸ é¢„ç®—ä½¿ç”¨å·²è¶…è¿‡80%ï¼Œè¯·æ³¨æ„æ§åˆ¶æ”¯å‡ºï¼";
              showWarning = true;
            } else if(level === "tight" || percent >= 50){
              cardColor = "#fef3c7"; // æµ…é»„è‰²èƒŒæ™¯
              progressColor = "#f59e0b"; // æ©™è‰²è¿›åº¦æ¡
              warningColor = "#d97706"; // æ·±æ©™è‰²æ–‡å­—
              warningText = "ğŸ’¡ é¢„ç®—ä½¿ç”¨å·²è¿‡åŠï¼Œå»ºè®®å…³æ³¨åç»­æ”¯å‡ºã€‚";
              showWarning = true;
            } else {
              cardColor = "#f0fdf4"; // æµ…ç»¿è‰²èƒŒæ™¯
              progressColor = "#10b981"; // ç»¿è‰²è¿›åº¦æ¡
              warningColor = "#059669"; // æ·±ç»¿è‰²æ–‡å­—
              warningText = "âœ… é¢„ç®—ä½¿ç”¨æ­£å¸¸ï¼Œç»§ç»­ä¿æŒï¼";
              showWarning = true;
            }
            
            // åº”ç”¨æ ·å¼
            card.style.background = cardColor;
            progress.style.background = progressColor;
            warning.style.color = warningColor;
            warning.style.background = cardColor;
            warning.textContent = warningText;
            warning.style.display = showWarning ? "block" : "none";
            
            // æ›´æ–°è¿›åº¦æ¡
            progress.style.width = `${Math.min(100, percent)}%`;
            
          }catch(e){ console.error(e); }
        });
      }

      function showBudgetAlert(title, message, type){
        const alertDiv = document.createElement("div");
        alertDiv.style.cssText = `
          position:fixed; left:50%; top:50%; transform:translate(-50%, -50%);
          background:${type==="error"?"#dc2626":"#f59e0b"}; color:#fff;
          border-radius:16px; padding:20px; max-width:320px; z-index:2000;
          box-shadow:0 20px 40px rgba(0,0,0,0.3); text-align:center;
        `;
        alertDiv.innerHTML = `
          <div style="font-size:18px;font-weight:700;margin-bottom:12px">${title}</div>
          <div style="font-size:14px;line-height:1.6;white-space:pre-wrap">${message}</div>
          <button id="budget-alert-close" style="margin-top:16px;padding:8px 20px;background:rgba(255,255,255,0.2);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:700">çŸ¥é“äº†</button>
        `;
        document.body.appendChild(alertDiv);
        alertDiv.querySelector("#budget-alert-close").addEventListener("click", ()=>{
          alertDiv.remove();
        });
        // 5ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(()=>{ if(alertDiv.parentNode) alertDiv.remove(); }, 5000);
      }

      // ç»Ÿè®¡åŠŸèƒ½
      let chartMode = "expense"; // é»˜è®¤çœ‹æ”¯å‡ºåˆ†ç±»
      let currentPeriod = "month"; // å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
      let customStartDate = null;
      let customEndDate = null;

      function bindStats(){
        document.getElementById("open-insights").addEventListener("click", ()=>{
          showPage("insights");
          // ç”Ÿæˆåˆ†æ
          backend.get_ai_analysis("month", function(txt){ document.getElementById("insights-text").textContent = txt; });
        });
        document.getElementById("insights-back").addEventListener("click", ()=>{ showPage("stats"); });

        document.getElementById("stats-expense-card").addEventListener("click", ()=>{ chartMode="expense"; loadStats(); });
        document.getElementById("stats-income-card").addEventListener("click", ()=>{ chartMode="income";  loadStats(); });

        // æ—¶é—´èŒƒå›´é€‰æ‹©æŒ‰é’®
        document.querySelectorAll("[data-period]").forEach(btn => {
          btn.addEventListener("click", ()=>{
            const period = btn.dataset.period;
            currentPeriod = period;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll("[data-period]").forEach(b => {
              b.style.background = b === btn ? "var(--primary)" : "";
            });
            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©
            const customRange = document.getElementById("custom-date-range");
            if(period === "custom"){
              customRange.style.display = "flex";
              customRange.style.flexDirection = "column";
            } else {
              customRange.style.display = "none";
              loadStats();
            }
          });
        });

        // è‡ªå®šä¹‰æ—¥æœŸåº”ç”¨æŒ‰é’®
        document.getElementById("stats-apply-custom").addEventListener("click", ()=>{
          const startDate = document.getElementById("stats-start-date").value;
          const endDate = document.getElementById("stats-end-date").value;
          if(startDate && endDate){
            customStartDate = startDate;
            customEndDate = endDate;
            loadStats();
          } else {
            toast("è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ");
          }
        });
      }

      function loadStats(){
        if(!backend) return;
        const params = {period: currentPeriod};
        if(currentPeriod === "custom" && customStartDate && customEndDate){
          params.start_date = customStartDate;
          params.end_date = customEndDate;
        }
        backend.get_statistics(JSON.stringify(params), function(resp){
          try{
            const obj = JSON.parse(resp)||{};
            document.getElementById("stats-expense").textContent = fmt(obj.totals?.expense||0);
            document.getElementById("stats-income").textContent  = fmt(obj.totals?.income||0);

            // è¶‹åŠ¿æŠ˜çº¿å›¾
            const trendData = obj.trendData || {dates: [], income: [], expense: []};
            const trendDom = document.getElementById("trend-chart");
            const trendChart = echarts.getInstanceByDom(trendDom) || echarts.init(trendDom);
            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæœˆ-æ—¥ï¼‰
            const formattedDates = trendData.dates.map(d => {
              const date = new Date(d);
              return `${date.getMonth()+1}-${date.getDate()}`;
            });
            trendChart.setOption({
              tooltip:{trigger:"axis", formatter:function(params){
                let result = params[0].axisValue + "<br/>";
                params.forEach(p => {
                  result += `${p.seriesName}: ${fmt(p.value)}<br/>`;
                });
                return result;
              }},
              legend:{data:["æ”¶å…¥","æ”¯å‡º"], bottom:"5%", textStyle:{color:"#4b5563", fontSize:12}},
              grid:{left:"3%", right:"4%", bottom:"15%", top:"10%", containLabel:true},
              xAxis:{type:"category", data:formattedDates, boundaryGap:false, axisLabel:{fontSize:10}},
              yAxis:{type:"value", axisLabel:{formatter:"Â¥{value}", fontSize:10}},
              series:[
                {name:"æ”¶å…¥", type:"line", data:trendData.income, smooth:true, itemStyle:{color:"#10b981"}, areaStyle:{opacity:0.2}},
                {name:"æ”¯å‡º", type:"line", data:trendData.expense, smooth:true, itemStyle:{color:"#ef4444"}, areaStyle:{opacity:0.2}}
              ]
            }, true);

            // åˆ†ç±»é¥¼å›¾
            const seriesData = (chartMode==="income" ? (obj.incomeSeries||[]) : (obj.expenseSeries||[]));
            const dom = document.getElementById("main-chart");
            const chart = echarts.getInstanceByDom(dom) || echarts.init(dom);
            chart.setOption({
              tooltip:{trigger:"item", formatter:"{b}: {c} ({d}%)"},
              legend:{bottom:"5%",left:"center",textStyle:{color:"#4b5563"}},
              series:[{
                type:"pie", name: chartMode==="income"?"æ”¶å…¥åˆ†å¸ƒ":"æ”¯å‡ºåˆ†å¸ƒ",
                radius:["40%","70%"], avoidLabelOverlap:false,
                itemStyle:{borderRadius:8,borderColor:"#fff",borderWidth:2},
                label:{show:false}, emphasis:{label:{show:true,fontSize:14,fontWeight:"bold"}},
                labelLine:{show:false}, data: seriesData
              }]}
            , true);
          }catch(e){ console.error(e); }
        });
      }

      // å·¥å…·å‡½æ•°
      function fmt(n){ const v = Number(n)||0; return "Â¥"+v.toFixed(2); }
      function fmtRaw(n){ const v = Number(n)||0; return v.toFixed(2); }
      function el(html){ const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; }
      function toast(msg){
        const div = document.createElement("div");
        div.style.cssText = "position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;border-radius:999px;padding:8px 14px;font-size:13px;z-index:1000;";
        div.textContent = msg; document.body.appendChild(div);
        setTimeout(()=>{ div.remove(); }, 1400);
      }

    })();
  </script>
</body>
</html>
